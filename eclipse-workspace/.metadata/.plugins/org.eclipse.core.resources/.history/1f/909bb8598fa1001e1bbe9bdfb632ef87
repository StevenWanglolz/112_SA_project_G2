<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>首頁</title>

  <link href="statics/css/bootstrap.min.css" rel="stylesheet">
  <link href="statics/icons/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="statics/css/hugo.css" rel="stylesheet">

  <script src="statics/js/bootstrap.min.js"></script>
  <script src="statics/js/hugo.js"></script>
  <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
</head>
<body>  
    <!-- navbar -->
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
          <button class="navbar-toggler border-0 ps-1" type="button" data-bs-toggle="collapse" data-bs-target="#navbarTogglerDemo03" aria-controls="navbarTogglerDemo03" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <a class="navbar-brand ms-1" aria-current="page" href="index.html">學生資源分享站</a>
            <div class="collapse navbar-collapse" id="navbarTogglerDemo03">
                <ul class="navbar-nav me-auto ms-2 mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="index.html">
                            <i class="bi bi-house-door-fill"></i> 首頁
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="member_page" href="member.html">
                          <i class="bi bi-person"></i> 個人主頁
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="alert_page" href="#">
                            <i class="bi bi-chat"></i> 通知欄
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="admin_page" href="admin.html" style="display: none;">
                            <i class="bi bi-database"></i> 連線測試
                        </a>
                    </li>
                </ul>
                <!-- search bar -->
                <form role="search">
                    <div class="input-group">
                      <span class="input-group-text bg-white text-secondary border-end-0 ms-1 pe-2" id="basic-addon1"><i class="bi bi-search"></i></span>
                      <input type="search" class="form-control border-start-0 me-1 ps-2" placeholder="搜尋" aria-label="Search" aria-describedby="basic-addon1">
                    </div>
                </form>
                <div class="text-center">
                    <a type="button" id="loginBtn" class="btn btn-primary mx-1 my-2" href="login.html">
                      <i class="bi bi-box-arrow-in-right"></i> 登入
                    </a>
                </div>
                <div class="text-center">
                    <a type="button" id="logoutBtn" class="btn btn-outline-danger mx-1 my-2" onclick="logout()" style="display: none;">
                      <i class="bi bi-box-arrow-right"></i> 登出
                    </a>
                </div>
            </div>
        </div>
    </nav>
    
    <main>
    
    <!-- all posts -->
    <div class="album py-5">
      <div class="container" id="post_container">
        <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-xl-4 g-3">

          <div class="col">
            <div class="card" id="post" onclick="showPostInfo(1)" data-bs-toggle="modal" data-bs-target="#file_info">
              <img class="bd-placeholder-img card-img-top object-fit-cover" width="100%" height="225" src="" alt="文件檔案"></img>
              <div class="card-body">
                <h5 class="card-title">標題</h5>
                <p class="card-text text-truncate">這裡寫文件說明</p>
                <div class="d-flex justify-content-between align-items-center">
                  <span class="badge rounded-pill text-bg-dark">類別</span>
                  <small class="text-body-secondary">by 作者</small>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </div>
    </div>

    <!-- Post Info Modal -->
    <div class="modal fade" id="file_info" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable modal-fullscreen-sm-down">
        <div class="modal-content">
          <div class="modal-header border-bottom-0">
            <h1 class="modal-title fs-5">文件內容</h1>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body m-3">
            <div class="row mb-3">
              <label for="post_name" class="col-sm-2 col-form-label">名稱</label>
              <div class="col-sm-10">
                <input type="text" class="form-control-plaintext rounded-3" id="post_name" value="file_name" readonly>
              </div>
            </div>
            <div class="row mb-3">
              <label for="form-check" class="col-sm-2 col-form-label">類型</label>
              <div class="col-sm-10">
                <span class="badge rounded-pill text-bg-dark" id="post_type">類別:</span>
              </div>
            </div>
            <div class="row mb-3">
              <label for="member_name" class="col-sm-2 col-form-label">作者</label>
              <div class="col-sm-10">
                <input type="text" class="form-control-plaintext rounded-3" id="member_name" value="auther" readonly>
              </div>
            </div>
            <div class="row mb-3 col-12">
              <label for="file_img" class="col-sm-2 col-form-label">檔案</label>
              <div id="file_container" class="col-sm-10"></div>
            </div>
            <div class="row mb-3 col-12">
              <label for="post_description" class="col-sm-2 col-form-label">說明</label>
              <div class="col-sm-10">
                <textarea class="form-control rounded-3" id="post_description" value="" style="height: 140px" readonly></textarea>
              </div>
            </div>
            <div class="flex text-center">
              <button id="delete_post_btn" type="button" class="btn btn-danger">刪除檔案</button>
              <button id="download_post_btn" type="button" class="btn btn-success"><i class="bi bi-download"></i> 下載檔案</button>
            </div>
          </div>  
        </div>
      </div>
    </div>
  
    </main>

    <script>
        // 確認登入狀況
        checkLoginStatus();
        //getAllPost();
        getSearchPost();

        function checkLoginStatus() {
          const memberLoggedIn = getCookie('memberLoggedIn');
          const adminLoggedIn = getCookie('adminLoggedIn');

          if (memberLoggedIn === 'true' || adminLoggedIn === 'true') {
            // 用戶已登入
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('logoutBtn').style.display = 'block';
            if(adminLoggedIn === 'true'){
              document.getElementById('member_page').style.display = 'none';
              document.getElementById('alert_page').style.display = 'none';
              document.getElementById('admin_page').style.display = 'block';
              document.getElementById('delete_post_btn').className = "btn btn-danger";

            }else{
              document.getElementById('member_page').style.display = 'block';
              document.getElementById('alert_page').style.display = 'block';
              document.getElementById('delete_post_btn').className = "d-none";
            }
          } else {
            // 用戶未登入
            document.getElementById('loginBtn').style.display = 'block';
            document.getElementById('logoutBtn').style.display = 'none';
            document.getElementById('member_page').style.display = 'none';
            document.getElementById('alert_page').style.display = 'none';
          }
        }

        function getAllPost() {
          $.ajax({
            type: "GET",
            url: "api/post.do",
            crossDomain: true,
            cache: false,
            dataType: 'json',
            timeout: 5000,
            success: function (response) {
              // alert("成功連線到伺服器！");
              // updatePosts(response.response.data);
              if(response.status == 200){
                updatePosts(response.response.data);
              }
              console.log(response);
            },
            error: function () {
              alert("無法連線到伺服器！");
            }
          });
        }
        
        function getSearchPost() {
          $.ajax({
            type: "GET",
            url: "api/search.do",
            crossDomain: true,
            cache: false,
            dataType: 'json',
            timeout: 5000,
            success: function (response) {
              // alert("成功連線到伺服器！");
              // updatePosts(response.response.data);
              if(response.status == 200){
                updatePosts(response.response.data);
              }
              console.log(response);
            },
            error: function () {
              alert("無法連線到伺服器！");
            }
          });
        }

        function updatePosts(data){
          $("#post_container > div").empty();
          var post_html = '';
          var post_type = '';
          var initial_file_path = 'filepath/notebook.pdf';
          $.each(data, function(index, value) {
            if(value["page"] == 1){
              console.log(value["file_path"], index);
              if(typeof value["file_path"] == 'undefined'){
                post_html += '<div class="col"><div class="card" id="post" onclick="showPostInfo(' + value["post_id"] + ')" data-bs-toggle="modal" data-bs-target="#file_info"><img class="bd-placeh